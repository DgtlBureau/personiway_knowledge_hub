name: Check Pushes and Notify Discord

on:
  schedule:
    - cron: '0 18 * * 3,5'
    - cron: '0 18 * * 5'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Ð¢Ð¸Ð¿ Ð²ÐµÑ‚ÐºÐ¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ (development Ð¸Ð»Ð¸ production)'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

jobs:
  check-development-pushes:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 18 * * 3,5' || (github.event_name == 'workflow_dispatch' && github.event.inputs.branch == 'development')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check development pushes
        id: check_development
        run: |
          TODAY=$(date +%Y-%m-%d)

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÑƒÑˆÐ¸ Ð² develop
          DEVELOP_COMMITS=$(git log --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --format="%H" origin/develop 2>/dev/null || echo "")

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÑƒÑˆÐ¸ Ð² dev
          DEV_COMMITS=$(git log --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --format="%H" origin/dev 2>/dev/null || echo "")

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð° Ð»Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð² ÐºÐ°ÐºÐ¾Ð¹-Ð»Ð¸Ð±Ð¾ Ð¸Ð· Ð²ÐµÑ‚Ð¾Ðº
          if [ -z "$DEVELOP_COMMITS" ] && [ -z "$DEV_COMMITS" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "NO_PUSHES=true" >> $GITHUB_OUTPUT

            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð´ÐµÐ½ÑŒ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð´Ð»Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
            DAY_OF_WEEK=$(date +%u)
            if [ "$DAY_OF_WEEK" == "3" ]; then
              echo "DAY_NAME=ÑÑ€ÐµÐ´Ñƒ" >> $GITHUB_OUTPUT
            else
              echo "DAY_NAME=Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñƒ" >> $GITHUB_OUTPUT
            fi

            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼, ÐºÐ°ÐºÐ¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚
            if git ls-remote --heads origin develop &>/dev/null; then
              echo "HAS_DEVELOP=true" >> $GITHUB_OUTPUT
            else
              echo "HAS_DEVELOP=false" >> $GITHUB_OUTPUT
            fi

            if git ls-remote --heads origin dev &>/dev/null; then
              echo "HAS_DEV=true" >> $GITHUB_OUTPUT
            else
              echo "HAS_DEV=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "NO_PUSHES=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification for development
        if: steps.check_development.outputs.NO_PUSHES == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "::error::DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi

          DAY_NAME="${{ steps.check_development.outputs.DAY_NAME }}"
          HAS_DEVELOP="${{ steps.check_development.outputs.HAS_DEVELOP }}"
          HAS_DEV="${{ steps.check_development.outputs.HAS_DEV }}"

          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑÐ¼Ð¸ Ð²ÐµÑ‚Ð¾Ðº
          if [ "$HAS_DEVELOP" == "true" ] && [ "$HAS_DEV" == "true" ]; then
            BRANCH_NAME="develop Ð¸ dev"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÐ¸ **develop** Ð¸ **dev**"
          elif [ "$HAS_DEVELOP" == "true" ]; then
            BRANCH_NAME="develop"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÑƒ **develop**"
          elif [ "$HAS_DEV" == "true" ]; then
            BRANCH_NAME="dev"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÑƒ **dev**"
          else
            BRANCH_NAME="development"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÐ¸ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸"
          fi

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TEST_MODE="[Ð¢Ð•Ð¡Ð¢ÐžÐ’Ð«Ð™ Ð Ð•Ð–Ð˜Ðœ] "
          else
            TEST_MODE=""
          fi

          cat > discord_payload.json << EOF
          {
            "embeds": [{
              "title": "${TEST_MODE}âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•! ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚ Ð¿ÑƒÑˆÐ¸ Ð² Ð²ÐµÑ‚ÐºÐ¸ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸",
              "description": "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ (Ð² $DAY_NAME) Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð¿ÑƒÑˆÐµÐ¹ Ð² $BRANCH_TEXT!",
              "color": 16763904,
              "fields": [
                {
                  "name": "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹",
                  "value": "${{ github.repository }}",
                  "inline": true
                },
                {
                  "name": "Ð’ÐµÑ‚ÐºÐ¸",
                  "value": "$BRANCH_NAME",
                  "inline": true
                },
                {
                  "name": "ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ",
                  "value": "ÐŸÑƒÑˆÐ¸ Ð² Ð²ÐµÑ‚ÐºÐ¸ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑ‚ÑŒÑÑ Ð¿Ð¾ ÑÑ€ÐµÐ´Ð°Ð¼ Ð¸ Ð¿ÑÑ‚Ð½Ð¸Ñ†Ð°Ð¼."
                }
              ],
              "footer": {
                "text": "GitHub Actions ID: ${{ github.run_id }} | ${{ github.event_name }} trigger"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json

  check-production-pushes:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 18 * * 5' || (github.event_name == 'workflow_dispatch' && github.event.inputs.branch == 'production')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check production pushes
        id: check_production
        run: |
          TODAY=$(date +%Y-%m-%d)

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÑƒÑˆÐ¸ Ð² master
          MASTER_COMMITS=$(git log --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --format="%H" origin/master 2>/dev/null || echo "")

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÑƒÑˆÐ¸ Ð² main
          MAIN_COMMITS=$(git log --since="$TODAY 00:00:00" --until="$TODAY 23:59:59" --format="%H" origin/main 2>/dev/null || echo "")

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð° Ð»Ð¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð² ÐºÐ°ÐºÐ¾Ð¹-Ð»Ð¸Ð±Ð¾ Ð¸Ð· Ð²ÐµÑ‚Ð¾Ðº
          if [ -z "$MASTER_COMMITS" ] && [ -z "$MAIN_COMMITS" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "NO_PUSHES=true" >> $GITHUB_OUTPUT

            # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼, ÐºÐ°ÐºÐ¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚
            if git ls-remote --heads origin master &>/dev/null; then
              echo "HAS_MASTER=true" >> $GITHUB_OUTPUT
            else
              echo "HAS_MASTER=false" >> $GITHUB_OUTPUT
            fi

            if git ls-remote --heads origin main &>/dev/null; then
              echo "HAS_MAIN=true" >> $GITHUB_OUTPUT
            else
              echo "HAS_MAIN=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "NO_PUSHES=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord notification for production
        if: steps.check_production.outputs.NO_PUSHES == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "::error::DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi

          HAS_MASTER="${{ steps.check_production.outputs.HAS_MASTER }}"
          HAS_MAIN="${{ steps.check_production.outputs.HAS_MAIN }}"

          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑÐ¼Ð¸ Ð²ÐµÑ‚Ð¾Ðº
          if [ "$HAS_MASTER" == "true" ] && [ "$HAS_MAIN" == "true" ]; then
            BRANCH_NAME="master Ð¸ main"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÐ¸ **master** Ð¸ **main**"
          elif [ "$HAS_MASTER" == "true" ]; then
            BRANCH_NAME="master"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÑƒ **master**"
          elif [ "$HAS_MAIN" == "true" ]; then
            BRANCH_NAME="main"
            BRANCH_TEXT="Ð²ÐµÑ‚ÐºÑƒ **main**"
          else
            BRANCH_NAME="production"
            BRANCH_TEXT="Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸"
          fi

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TEST_MODE="[Ð¢Ð•Ð¡Ð¢ÐžÐ’Ð«Ð™ Ð Ð•Ð–Ð˜Ðœ] "
          else
            TEST_MODE=""
          fi

          cat > discord_payload.json << EOF
          {
            "embeds": [{
              "title": "${TEST_MODE}ðŸš¨ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• ÐŸÐ Ð•Ð”Ð£ÐŸÐ Ð•Ð–Ð”Ð•ÐÐ˜Ð•!",
              "description": "Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ (Ð² Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñƒ) Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð¿ÑƒÑˆÐµÐ¹ Ð² $BRANCH_TEXT!",
              "color": 16711680,
              "fields": [
                {
                  "name": "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹",
                  "value": "${{ github.repository }}",
                  "inline": true
                },
                {
                  "name": "Ð’ÐµÑ‚ÐºÐ¸",
                  "value": "$BRANCH_NAME",
                  "inline": true
                },
                {
                  "name": "Ð¡Ñ€Ð¾Ñ‡Ð½Ð°Ñ Ð¼ÐµÑ€Ð°",
                  "value": "ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑÑ€Ð¾Ñ‡Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð²ÐµÑ‚ÐºÐ¸ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ."
                }
              ],
              "footer": {
                "text": "GitHub Actions ID: ${{ github.run_id }} | ${{ github.event_name }} trigger"
              },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF

          curl -s -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @discord_payload.json
